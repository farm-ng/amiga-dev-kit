"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[5301],{183:(t,e,i)=>{i.r(e),i.d(e,{assets:()=>s,contentTitle:()=>r,default:()=>k,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var n=i(7462),a=(i(7294),i(3905));i(1839);const o={id:"virtual-joystick-widget",title:"03 - Virtual Joystick Widget"},r="Virtual Joystick Widget",l={unversionedId:"tutorials/virtual_joystick/virtual-joystick-widget",id:"tutorials/virtual_joystick/virtual-joystick-widget",title:"03 - Virtual Joystick Widget",description:"We will now define a custom widget, the VirtualJoystickWidget, in kivy and Python to give an introduction to kivy drawing.",source:"@site/docs/tutorials/virtual_joystick/03_virtual_joystick_widget.md",sourceDirName:"tutorials/virtual_joystick",slug:"/tutorials/virtual_joystick/virtual-joystick-widget",permalink:"/docs/tutorials/virtual_joystick/virtual-joystick-widget",draft:!1,editUrl:"https://github.com/farm-ng/amiga-dev-kit/tree/main/website/docs/tutorials/virtual_joystick/03_virtual_joystick_widget.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{id:"virtual-joystick-widget",title:"03 - Virtual Joystick Widget"},sidebar:"examples",previous:{title:"02 - Device Streams",permalink:"/docs/tutorials/virtual_joystick/device-streams"},next:{title:"04 - Auto Control",permalink:"/docs/tutorials/virtual_joystick/auto-control"}},s={},d=[{value:"kivy Definition",id:"kivy-definition",level:3},{value:"Python Implementation",id:"python-implementation",level:3},{value:"Builder",id:"builder",level:4},{value:"kivy <code>Clock</code>",id:"kivy-clock",level:4},{value:"Touch handling",id:"touch-handling",level:4},{value:"Vec2",id:"vec2",level:4},{value:"Add it to the app",id:"add-it-to-the-app",level:3},{value:"Run it",id:"run-it",level:3}],p={toc:d};function k(t){let{components:e,...i}=t;return(0,a.kt)("wrapper",(0,n.Z)({},p,i,{components:e,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"virtual-joystick-widget"},"Virtual Joystick Widget"),(0,a.kt)("p",null,"We will now define a custom widget, the ",(0,a.kt)("inlineCode",{parentName:"p"},"VirtualJoystickWidget"),", in kivy and Python to give an introduction to kivy drawing.\nWe define the custom widget such that it can be imported just like a kivy API widget!"),(0,a.kt)("p",null,"This widget will be used to drive the robot by moving the virtual joystick on the Brain screen.\nThe driving behavior is modelled after the behavior of driving with the joystick on the pendant."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"In the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/farm-ng/virtual-joystick/blob/main/libs/virtual_joystick/res/joystick.kv"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"libs/virtual_joystick/res/joystick.kv")))," and ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/farm-ng/virtual-joystick/blob/main/libs/virtual_joystick/joystick.py"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"libs/virtual_joystick/joystick.py")))," files of the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/farm-ng/virtual-joystick"},(0,a.kt)("strong",{parentName:"a"},"virtual-joystick"))," app we define the custom widget in kivy and Python."),(0,a.kt)("p",{parentName:"admonition"},"You should open these files for reference as you follow along.")),(0,a.kt)("h3",{id:"kivy-definition"},"kivy Definition"),(0,a.kt)("p",null,"We first define a few custom arguments for defining the drawn ",(0,a.kt)("inlineCode",{parentName:"p"},"joystick")," that are linked to the ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.graphics.html#kivy.graphics.Ellipse"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"Ellipse")))," widget used to draw the joystick circle (the one with ",(0,a.kt)("inlineCode",{parentName:"p"},"id: joystick"),").\nBecause these values are linked, they can be updated on the Python side of the ",(0,a.kt)("inlineCode",{parentName:"p"},"VirtualJoystickWidget")," and the kivy drawing will update accordingly."),(0,a.kt)("p",null,"An important component to understand is the kivy ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.graphics.instructions.html"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"Canvas"))),",\nwhich is the root object used for drawing by a ",(0,a.kt)("inlineCode",{parentName:"p"},"Widget"),".\nAs you can see, both the background ",(0,a.kt)("inlineCode",{parentName:"p"},"Ellipse")," and the joystick ",(0,a.kt)("inlineCode",{parentName:"p"},"Ellipse")," are drawn within the scope of the canvas.\nAlso note how the ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.graphics.html#kivy.graphics.Color"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"Color")))," is set before drawing each widget in ",(0,a.kt)("inlineCode",{parentName:"p"},"rgba")," format, allowing color and alpha adjustments."),(0,a.kt)("h3",{id:"python-implementation"},"Python Implementation"),(0,a.kt)("h4",{id:"builder"},"Builder"),(0,a.kt)("p",null,"By building the ",(0,a.kt)("inlineCode",{parentName:"p"},".kv")," definition of the ",(0,a.kt)("inlineCode",{parentName:"p"},"VirtualJoystickWidget")," in the Python constructor,\nthe widget can be imported just like a kivy API widget.\nThat means you can import it into your Python definition of your ",(0,a.kt)("inlineCode",{parentName:"p"},"App")," (i.e., ",(0,a.kt)("inlineCode",{parentName:"p"},"main.py"),"), and reference it both there and in your kivy app definition (i.e., ",(0,a.kt)("inlineCode",{parentName:"p"},"main.kv"),")"),(0,a.kt)("p",null,"Explore ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.lang.builder.html"},(0,a.kt)("strong",{parentName:"a"},"kivy ",(0,a.kt)("inlineCode",{parentName:"strong"},"Builder")))," for more details."),(0,a.kt)("h4",{id:"kivy-clock"},"kivy ",(0,a.kt)("inlineCode",{parentName:"h4"},"Clock")),(0,a.kt)("p",null,"We schedule regular updates to the linked variables containing the pose of the drawn joystick using the ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.clock.html"},(0,a.kt)("strong",{parentName:"a"},"kivy Clock")),".\nkivy provides multiple options for scheduling tasks, which you can explore in their API."),(0,a.kt)("p",null,"Updating these linked values will cause the drawn Widget to automatically update.\nYou could alternatively update these values as they are calculated in the touch handling methods if you don't want to use the kivy ",(0,a.kt)("inlineCode",{parentName:"p"},"Clock"),"."),(0,a.kt)("admonition",{type:"caution"},(0,a.kt)("p",{parentName:"admonition"},"Do not schedule long running, blocking tasks with the kivy clock or you will freeze the app while the task executes.\nThe kivy clock (which runs on the main loop) should only be used to schedule very quick actions."),(0,a.kt)("p",{parentName:"admonition"},"Blocking tasks should be scheduled as an ",(0,a.kt)("inlineCode",{parentName:"p"},"asyncio")," task!")),(0,a.kt)("h4",{id:"touch-handling"},"Touch handling"),(0,a.kt)("p",null,"The ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.uix.widget.html#kivy.uix.widget.Widget.on_touch_down"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"on_touch_down()"))),", ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.uix.widget.html#kivy.uix.widget.Widget.on_touch_move"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"on_touch_move()"))),", & ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.uix.widget.html#kivy.uix.widget.Widget.on_touch_up"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"on_touch_up()")))," calls are triggered for all ",(0,a.kt)("inlineCode",{parentName:"p"},"Widget"),"s within a kivy ",(0,a.kt)("inlineCode",{parentName:"p"},"App")," whenever there is a touch interaction (by default)."),(0,a.kt)("p",null,"We overwrite the default behavior of these methods to move the pose of the joystick whenever we touch and/or move within the ",(0,a.kt)("inlineCode",{parentName:"p"},"VirtualJoystickWidget"),",\nand recenter the joystick upon release."),(0,a.kt)("p",null,"From the ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.uix.widget.html"},(0,a.kt)("strong",{parentName:"a"},"kivy ",(0,a.kt)("inlineCode",{parentName:"strong"},"Widget")," class docs")),", which all widgets inherit from:"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},(0,a.kt)("inlineCode",{parentName:"p"},"on_touch_down()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"on_touch_move()"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"on_touch_up()")," don\u2019t do any sort of collisions.\nIf you want to know if the touch is inside your widget, use ",(0,a.kt)("inlineCode",{parentName:"p"},"collide_point()"),".")),(0,a.kt)("p",null,"So we filter ",(0,a.kt)("inlineCode",{parentName:"p"},"on_touch_down()")," & ",(0,a.kt)("inlineCode",{parentName:"p"},"on_touch_move()")," with ",(0,a.kt)("a",{parentName:"p",href:"https://kivy.org/doc/stable/api-kivy.uix.widget.html#kivy.uix.widget.Widget.collide_point"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"collide_point()")))," to only perform our custom behavior when the touch occurred within our ",(0,a.kt)("inlineCode",{parentName:"p"},"VirtualJoystickWidget"),"."),(0,a.kt)("p",null,"Because we want to recenter the joystick regardless of which widget the ",(0,a.kt)("inlineCode",{parentName:"p"},"touch_up")," occurred in, we do not filter ",(0,a.kt)("inlineCode",{parentName:"p"},"on_touch_up()")," with ",(0,a.kt)("inlineCode",{parentName:"p"},"collide_point()"),"."),(0,a.kt)("h4",{id:"vec2"},"Vec2"),(0,a.kt)("p",null,"We also define a simple container called ",(0,a.kt)("inlineCode",{parentName:"p"},"Vec2")," for handling the ",(0,a.kt)("inlineCode",{parentName:"p"},"x")," & ",(0,a.kt)("inlineCode",{parentName:"p"},"y")," values of the joystick coordinates in ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/farm-ng/virtual-joystick/blob/main/libs/virtual_joystick/utils.py"},(0,a.kt)("strong",{parentName:"a"},"libs/virtual_joystick/utils.py"))," and import this into ",(0,a.kt)("inlineCode",{parentName:"p"},"joystick.py"),"."),(0,a.kt)("h3",{id:"add-it-to-the-app"},"Add it to the app"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Import this widget in ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/farm-ng/virtual-joystick/blob/main/src/main.py"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"src/main.py")))),(0,a.kt)("li",{parentName:"ul"},"Add the ",(0,a.kt)("inlineCode",{parentName:"li"},"VirtualJoystickWidget")," next to the ",(0,a.kt)("inlineCode",{parentName:"li"},"TabbedPanel")," in the ",(0,a.kt)("inlineCode",{parentName:"li"},"BoxLayout")," of app's kivy definition in ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/farm-ng/virtual-joystick/blob/main/src/res/main.kv"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"src/res/main.kv"))))),(0,a.kt)("h3",{id:"run-it"},"Run it"),(0,a.kt)("p",null,"Now sync the app to the Brain and launch it."),(0,a.kt)("p",null,"You should now see the virtual joystick between the camera stream (far right) and the ",(0,a.kt)("inlineCode",{parentName:"p"},"AmigaTpdo1")," values from the canbus (left).\nTry moving the joystick around with your finger and releasing it, but note: It won't drive yet!"),(0,a.kt)("p",null,(0,a.kt)("img",{parentName:"p",src:"https://user-images.githubusercontent.com/53625197/200641720-c722fa9f-f6a3-4918-a4f0-d7270b73fd43.png",alt:"joystick"})))}k.isMDXComponent=!0}}]);