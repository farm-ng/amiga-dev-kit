"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[3490],{3294:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));n(1839);const i={id:"service-counter",title:"Service Counter"},s=void 0,l={unversionedId:"examples/service_counter/service-counter",id:"examples/service_counter/service-counter",title:"Service Counter",description:"This is a subsequent example of the service_client example",source:"@site/docs/examples/service_counter/README.md",sourceDirName:"examples/service_counter",slug:"/examples/service_counter/",permalink:"/docs/examples/service_counter/",draft:!1,editUrl:"https://github.com/farm-ng/amiga-dev-kit/tree/main/website/docs/examples/service_counter/README.md",tags:[],version:"current",frontMatter:{id:"service-counter",title:"Service Counter"},sidebar:"examples",previous:{title:"Service Client",permalink:"/docs/examples/service_client/"},next:{title:"Service Propagation",permalink:"/docs/examples/service_propagation/"}},o={},c=[{value:"Requirements",id:"requirements",level:3},{value:"Create the service",id:"create-the-service",level:3},{value:"Create the client",id:"create-the-client",level:3},{value:"Run the example",id:"run-the-example",level:2},{value:"1. Run the service",id:"1-run-the-service",level:3},{value:"2. Subscribe to the service",id:"2-subscribe-to-the-service",level:3},{value:"3. Reset the counter",id:"3-reset-the-counter",level:3}],p={toc:c};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"This is a subsequent example of the ",(0,a.kt)("a",{parentName:"p",href:"/docs/examples/service_client/"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"service_client")))," example\nwhere we will show how to use the ",(0,a.kt)("inlineCode",{parentName:"p"},"publish")," method from ",(0,a.kt)("inlineCode",{parentName:"p"},"EventServiceGrpc")," to publish messages\nto later use the ",(0,a.kt)("inlineCode",{parentName:"p"},"EventClient")," to interact with the service."),(0,a.kt)("p",null,"In particular, we will create a service that will have a counter running in a separate\ntask and will publish the counter value at fixed rate. We will show how to use the client\nto subscribe to the service and will print the counter value every time it receives a message.\nIn addition, the client will be able to request the service to reset the counter to zero."),(0,a.kt)("h3",{id:"requirements"},"Requirements"),(0,a.kt)("p",null,"This example only requires the farm-ng-core package."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"pip3 install farm-ng-core\n\n")),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"We highly recommend to have some basic knowledge about\n",(0,a.kt)("a",{parentName:"p",href:"https://docs.python.org/3/library/asyncio.html"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"asyncio"))),",\n",(0,a.kt)("a",{parentName:"p",href:"https://grpc.io/docs/what-is-grpc/introduction/"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"gRPC"))),",\nand ",(0,a.kt)("a",{parentName:"p",href:"https://developers.google.com/protocol-buffers/docs/pythontutorial"},(0,a.kt)("strong",{parentName:"a"},(0,a.kt)("inlineCode",{parentName:"strong"},"protobuf"))),".")),(0,a.kt)("h3",{id:"create-the-service"},"Create the service"),(0,a.kt)("p",null,"We first create a service that will publish the counter value at a certain\nrate. For this, we will create a ",(0,a.kt)("inlineCode",{parentName:"p"},"counter.py")," program that will\ninstantiate the ",(0,a.kt)("inlineCode",{parentName:"p"},"EventServiceGrpc")," and will run the service leveraging\nthe ",(0,a.kt)("inlineCode",{parentName:"p"},"serve")," method with the ",(0,a.kt)("inlineCode",{parentName:"p"},"asyncio")," event loop."),(0,a.kt)("p",null,"In the same program, we will create a ",(0,a.kt)("inlineCode",{parentName:"p"},"CounterService")," class that will\nimplement the logic of the service, including the concurrent task that\nwill run the counter. The ",(0,a.kt)("inlineCode",{parentName:"p"},"CounterService")," class will also have a method\nto handle the ",(0,a.kt)("inlineCode",{parentName:"p"},"requests")," from the client. The ",(0,a.kt)("inlineCode",{parentName:"p"},"requests")," method is a\ncoroutine that triggers the ",(0,a.kt)("inlineCode",{parentName:"p"},"request_handler")," method in the service,\nin that case to reset the counter to zero."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'class CounterServer:\n    def __init__(self, event_service: EventServiceGrpc) -> None:\n        """Initialize the service.\n        Args:\n            event_service: The event service to use for communication.\n        """\n        self._event_service = event_service\n        self._event_service.add_request_reply_handler(self.request_reply_handler)\n\n        self._counter: int = 0\n        self._rate: float = 1.0\n\n    async def request_reply_handler(self, event: Event, message: Message) -> None:\n        """The callback for handling request/reply messages."""\n        if event.uri.path == "/reset_counter":\n            self._counter = 0\n\n        return Empty()\n\n    async def run(self) -> None:\n        """Run the main task."""\n        while True:\n            await self._event_service.publish("/counter", Int32Value(value=self._counter))\n            self._counter += 1\n            await asyncio.sleep(1.0 / self._rate)\n\n    async def serve(self) -> None:\n        await asyncio.gather(self._event_service.serve(), self.run())\n')),(0,a.kt)("h3",{id:"create-the-client"},"Create the client"),(0,a.kt)("p",null,"For the client, we will create a ",(0,a.kt)("inlineCode",{parentName:"p"},"client.py")," program that will implement a thin wrapper\nclass ",(0,a.kt)("inlineCode",{parentName:"p"},"CounterClient")," around the ",(0,a.kt)("inlineCode",{parentName:"p"},"EventClient")," class. The ",(0,a.kt)("inlineCode",{parentName:"p"},"CounterClient")," will\nhave a method to ",(0,a.kt)("inlineCode",{parentName:"p"},"subscribe")," to the events stream coming from the ",(0,a.kt)("inlineCode",{parentName:"p"},"/counter")," path."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'class CounterClient:\n    def __init__(self, service_config: EventServiceConfig) -> None:\n        """Initialize the client.\n        Args:\n            service_config: The service config.\n        """\n        self._event_client = EventClient(service_config)\n\n    async def subscribe(self) -> None:\n        """Run the main task."""\n        async for event, message in self._event_client.subscribe(\n            request=SubscribeRequest(uri=Uri(path="/counter"), every_n=1), decode=True\n        ):\n            print(f"Received message: {message}")\n')),(0,a.kt)("p",null,"In the same program, we will create a ",(0,a.kt)("inlineCode",{parentName:"p"},"main")," function that will instantiate the\n",(0,a.kt)("inlineCode",{parentName:"p"},"EventServiceConfig")," and the ",(0,a.kt)("inlineCode",{parentName:"p"},"CounterClient"),". The ",(0,a.kt)("inlineCode",{parentName:"p"},"main")," function will have a\ncouple high level commands to ",(0,a.kt)("inlineCode",{parentName:"p"},"subscribe")," to the ",(0,a.kt)("inlineCode",{parentName:"p"},"/counter")," path and to ",(0,a.kt)("inlineCode",{parentName:"p"},"request"),"\nthe service to reset the counter to zero."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-python"},'async def command_subscribe(client: CounterClient) -> None:\n    """Subscribe to the counter service."""\n    await client.subscribe()\n\n\nasync def command_reset(client: CounterClient) -> None:\n    """Reset the counter."""\n    await client._event_client.request_reply("/reset_counter", Empty())\n')),(0,a.kt)("h2",{id:"run-the-example"},"Run the example"),(0,a.kt)("h3",{id:"1-run-the-service"},"1. Run the service"),(0,a.kt)("p",null,"In a first terminal, run the service:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"python counter.py --service-config service_config.json\n")),(0,a.kt)("p",null,"you should see the following output:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Starting server on port 5001\nServer started\n")),(0,a.kt)("h3",{id:"2-subscribe-to-the-service"},"2. Subscribe to the service"),(0,a.kt)("p",null,"In a second terminal, run the client:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"python client.py --service-config service_config.json subscribe\n")),(0,a.kt)("p",null,"you should see the following output and the counter value increasing:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Received message: value: 3\n\nReceived message: value: 4\n\nReceived message: value: 5\n\nReceived message: value: 6\n\n...\n...\n")),(0,a.kt)("h3",{id:"3-reset-the-counter"},"3. Reset the counter"),(0,a.kt)("p",null,"In a third terminal, run the client:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"python client.py --service-config service_config.json reset\n")),(0,a.kt)("p",null,"you should see the following output:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"Received message:\nReceived message: value: 1\n\nReceived message: value: 2\n\nReceived message: value: 3\n...\n...\n")))}u.isMDXComponent=!0}}]);